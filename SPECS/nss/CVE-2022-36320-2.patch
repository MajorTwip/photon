From 2e93c3763f89674a7d30e64cf4f37e79f2aaad41 Mon Sep 17 00:00:00 2001
From: "John M. Schanck" <jschanck@mozilla.com>
Date: Tue, 9 May 2023 13:16:10 +0530
Subject: [PATCH] [PATCH] Bug 1760998 - avoid data race on primary password
 change.  r=rrelyea

Differential Revision: https://phabricator.services.mozilla.com/D146655

[sshedi: ported the fix to v3.44]
Signed-off-by: Shreenidhi Shedi <sshedi@vmware.com>
---
 nss/lib/softoken/sftkdb.c  | 6 +++++-
 nss/lib/softoken/sftkpwd.c | 6 +++++-
 2 files changed, 10 insertions(+), 2 deletions(-)

diff --git a/nss/lib/softoken/sftkdb.c b/nss/lib/softoken/sftkdb.c
index 409c910..f003f5a 100644
--- a/nss/lib/softoken/sftkdb.c
+++ b/nss/lib/softoken/sftkdb.c
@@ -314,7 +314,7 @@ sftkdb_fixupTemplateOut(CK_ATTRIBUTE *template, CK_OBJECT_HANDLE objectID,

     if ((keyHandle == NULL) ||
         ((SFTK_GET_SDB(keyHandle)->sdb_flags & SDB_HAS_META) == 0) ||
-        (keyHandle->passwordKey.data == NULL)) {
+        (sftkdb_PWCached(keyHandle) != SECSuccess)) {
         checkSig = PR_FALSE;
     }

@@ -1458,10 +1458,14 @@ sftkdb_CloseDB(SFTKDBHandle *handle)
         }
         (*handle->db->sdb_Close)(handle->db);
     }
+    if (handle->passwordLock) {
+        PZ_Lock(handle->passwordLock);
+    }
     if (handle->passwordKey.data) {
         PORT_ZFree(handle->passwordKey.data, handle->passwordKey.len);
     }
     if (handle->passwordLock) {
+        PZ_Unlock(handle->passwordLock);
         SKIP_AFTER_FORK(PZ_DestroyLock(handle->passwordLock));
     }
     if (handle->updatePasswordKey) {
diff --git a/nss/lib/softoken/sftkpwd.c b/nss/lib/softoken/sftkpwd.c
index 9f97c77..a895465 100644
--- a/nss/lib/softoken/sftkpwd.c
+++ b/nss/lib/softoken/sftkpwd.c
@@ -852,7 +852,11 @@ done:
 SECStatus
 sftkdb_PWCached(SFTKDBHandle *keydb)
 {
-    return keydb->passwordKey.data ? SECSuccess : SECFailure;
+    SECStatus rv;
+    PZ_Lock(keydb->passwordLock);
+    rv = keydb->passwordKey.data ? SECSuccess : SECFailure;
+    PZ_Unlock(keydb->passwordLock);
+    return rv;
 }

 static CK_RV
--
2.25.1
