From 22a0cccb4d9d002f33c1ba7a4b36812c7d4f46b5 Mon Sep 17 00:00:00 2001
From: Werner Lemberg <wl@gnu.org>
Date: Sat, 19 Mar 2022 06:40:17 +0100
Subject: [PATCH] * src/base/ftobjs.c (ft_open_face_internal): Properly guard
 `face_index`.

We must ensure that the cast to `FT_Int` doesn't change the sign.

Fixes #1139.
---
 src/base/ftobjs.c | 9 +++++++++
 1 file changed, 9 insertions(+)


From 0c2bdb01a2e1d24a3e592377a6d0822856e10df2 Mon Sep 17 00:00:00 2001
From: Werner Lemberg <wl@gnu.org>
Date: Sat, 19 Mar 2022 09:37:28 +0100
Subject: [PATCH] * src/base/ftobjs.c (FT_Request_Size): Guard `face->size`.

Fixes #1140.
---
 src/base/ftobjs.c | 3 +++
 1 file changed, 3 insertions(+)

This patch has been reworked for 2.9 branch.

--- a/src/base/ftobjs.c	2022-05-11 07:31:24.065983244 +0530
+++ b/src/base/ftobjs.c	2022-05-11 07:36:06.411212559 +0530
@@ -2344,6 +2344,14 @@
     FT_UNUSED( test_mac_fonts );
 #endif
 
+    /* only use lower 31 bits together with sign bit */
+    if ( face_index > 0 )
+      face_index &= 0x7FFFFFFFL;
+    else
+    {
+      face_index &= 0x7FFFFFFFL;
+      face_index  = -face_index;
+    }
 
 #ifdef FT_DEBUG_LEVEL_TRACE
     FT_TRACE3(( "FT_Open_Face: " ));
@@ -3200,6 +3208,9 @@
     if ( !face )
       return FT_THROW( Invalid_Face_Handle );
 
+    if ( !face->size )
+      return FT_THROW( Invalid_Size_Handle );
+
     if ( !req || req->width < 0 || req->height < 0 ||
          req->type >= FT_SIZE_REQUEST_TYPE_MAX )
       return FT_THROW( Invalid_Argument );
