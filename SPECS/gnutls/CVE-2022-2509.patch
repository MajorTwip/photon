From 666395f06dcb363da4a4400e6d3594283cd60cc8 Mon Sep 17 00:00:00 2001
From: Zoltan Fridrich <zfridric@redhat.com>
Date: Fri, 22 Jul 2022 12:00:11 +0200
Subject: [PATCH] Fix double free during gnutls_pkcs7_verify

Signed-off-by: Zoltan Fridrich <zfridric@redhat.com>

[sshedi: changes done while back porting]
- dropped NEWS changes
- dropped test changes, if not we need latest automake to make it work
Signed-off-by: Shreenidhi Shedi <sshedi@vmware.com>
---
 lib/x509/pkcs7.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/lib/x509/pkcs7.c b/lib/x509/pkcs7.c
index 0ff55ba..878f867 100644
--- a/lib/x509/pkcs7.c
+++ b/lib/x509/pkcs7.c
@@ -1318,7 +1318,8 @@ gnutls_x509_crt_t find_signer(gnutls_pkcs7_t pkcs7, gnutls_x509_trust_list_t tl,
 				issuer = find_verified_issuer_of(pkcs7, issuer, purpose, vflags);
 
 				if (issuer != NULL && gnutls_x509_crt_check_issuer(issuer, issuer)) {
-					if (prev) gnutls_x509_crt_deinit(prev);
+					if (prev && prev != signer)
+						gnutls_x509_crt_deinit(prev);
 					prev = issuer;
 					break;
 				}
-- 
2.25.1

