From dfdd298ef5c6a0e46a9d8c886107ff8d258284e0 Mon Sep 17 00:00:00 2001
From: Daniel Stenberg <daniel@haxx.se>
Date: Thu, 6 Oct 2022 14:13:36 +0200
Subject: [PATCH] http_proxy: restore the protocol pointer on error

Reported-by: Trail of Bits
---
 lib/http_proxy.c | 6 ++----
 1 file changed, 2 insertions(+), 4 deletions(-)

diff --git a/lib/http_proxy.c b/lib/http_proxy.c
index 1f87f6c62..cc20b3a80 100644
--- a/lib/http_proxy.c
+++ b/lib/http_proxy.c
@@ -210,14 +210,12 @@ void Curl_connect_done(struct Curl_easy *data)
   if(s && (s->tunnel_state != TUNNEL_EXIT)) {
     s->tunnel_state = TUNNEL_EXIT;
     Curl_dyn_free(&s->rcvbuf);
     Curl_dyn_free(&s->req);
 
-    /* restore the protocol pointer, if not already done */
-    if(s->prot_save)
-      data->req.p.http = s->prot_save;
-    s->prot_save = NULL;
+    /* restore the protocol pointer */
+    data->req.p.http = s->prot_save;
     data->info.httpcode = 0; /* clear it as it might've been used for the
                                 proxy */
     data->req.ignorebody = FALSE;
 #ifdef USE_HYPER
     data->state.hconnect = FALSE;
-- 
2.37.2
