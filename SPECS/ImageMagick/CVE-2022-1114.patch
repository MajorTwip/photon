From 8043433ba9ce0c550e09f2b3b6a3f5f62d802e6d Mon Sep 17 00:00:00 2001
From: Cristy <urban-warrior@imagemagick.org>
Date: Tue, 15 Mar 2022 21:59:33 -0400
Subject: [PATCH] Coders:
 https://github.com/ImageMagick/ImageMagick/issues/4947
 https://github.com/ImageMagick/ImageMagick/commit/4b0377467fb3e1864ccd91c54393ca5d9bdeb3db
 https://github.com/ImageMagick/ImageMagick/issues/4689

---
 coders/dcm.c | 22 ++++++++++------------
 1 file changed, 10 insertions(+), 12 deletions(-)

diff -ruN a/coders/dcm.c b/coders/dcm.c
--- a/coders/dcm.c	2021-12-22 21:03:36.000000000 +0000
+++ b/coders/dcm.c	2022-05-17 06:04:57.223314594 +0000
@@ -3267,20 +3267,17 @@
             If we're entering a sequence, push the current image parameters
             onto the stack, so we can restore them at the end of the sequence.
           */
-          info_copy=(DCMInfo *) AcquireMagickMemory(sizeof(info));
-          if (info_copy == (DCMInfo *) NULL)
+          DCMInfo *clone_info=(DCMInfo *) AcquireMagickMemory(sizeof(info));
+          if (clone_info == (DCMInfo *) NULL)
             ThrowDCMException(ResourceLimitError,"MemoryAllocationFailed")
-          (void) memcpy(info_copy,&info,sizeof(info));
-          info_copy->scale=(Quantum *) AcquireQuantumMemory(
-            info_copy->scale_size,sizeof(*info_copy->scale));
-          if (info_copy->scale == (Quantum *) NULL)
-            {
-              info_copy=(DCMInfo *) RelinquishMagickMemory(info_copy);
-              ThrowDCMException(ResourceLimitError,"MemoryAllocationFailed")
-            }
-          (void) memcpy(info_copy->scale,info.scale,info_copy->scale_size*
-            sizeof(*info_copy->scale));
-          AppendValueToLinkedList(stack,info_copy);
+          (void) memcpy(clone_info,&info,sizeof(info));
+          clone_info->scale=(Quantum *) AcquireQuantumMemory(
+            clone_info->scale_size+1,sizeof(*clone_info->scale));
+          if (clone_info->scale == (Quantum *) NULL)
+            ThrowDCMException(ResourceLimitError,"MemoryAllocationFailed")
+          (void) memcpy(clone_info->scale,info.scale,clone_info->scale_size*
+            sizeof(*clone_info->scale));
+          AppendValueToLinkedList(stack,clone_info);
           sequence_depth++;
         }
       datum=0;
