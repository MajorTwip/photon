From 37b3b2a7e0e3fa23c49ac5e79b56f4cf816b35de Mon Sep 17 00:00:00 2001
From: Oran Agra <oran@redislabs.com>
Date: Sun, 1 Jan 2023 19:44:12 +0200
Subject: [PATCH] Fix range issues in ZRANDMEMBER and HRANDFIELD
 (CVE-2023-22458)

missing range check in ZRANDMEMBER and HRANDIFLD leading to panic due
to protocol limitations
---
 src/t_hash.c             | 7 ++++++-
 src/t_zset.c             | 7 ++++++-
 tests/unit/type/hash.tcl | 5 +++++
 tests/unit/type/zset.tcl | 5 +++++
 4 files changed, 22 insertions(+), 2 deletions(-)

diff --git a/src/t_hash.c b/src/t_hash.c
index 0bf3a21a5f8c..75344a6d4880 100644
--- a/src/t_hash.c
+++ b/src/t_hash.c
@@ -1196,8 +1196,13 @@ void hrandfieldCommand(client *c) {
         if (c->argc > 4 || (c->argc == 4 && strcasecmp(c->argv[3]->ptr,"withvalues"))) {
             addReplyErrorObject(c,shared.syntaxerr);
             return;
-        } else if (c->argc == 4)
+        } else if (c->argc == 4) {
             withvalues = 1;
+            if (l < LONG_MIN/2 || l > LONG_MAX/2) {
+                addReplyError(c,"value is out of range");
+                return;
+            }
+        }
         hrandfieldWithCountCommand(c, l, withvalues);
         return;
     }
diff --git a/src/t_zset.c b/src/t_zset.c
index 7450cc448803..4381bf360499 100644
--- a/src/t_zset.c
+++ b/src/t_zset.c
@@ -4242,8 +4242,13 @@ void zrandmemberCommand(client *c) {
         if (c->argc > 4 || (c->argc == 4 && strcasecmp(c->argv[3]->ptr,"withscores"))) {
             addReplyErrorObject(c,shared.syntaxerr);
             return;
-        } else if (c->argc == 4)
+        } else if (c->argc == 4) {
             withscores = 1;
+            if (l < LONG_MIN/2 || l > LONG_MAX/2) {
+                addReplyError(c,"value is out of range");
+                return;
+            }
+        }
         zrandmemberWithCountCommand(c, l, withscores);
         return;
     }
diff --git a/tests/unit/type/hash.tcl b/tests/unit/type/hash.tcl
index f2a503722acd..4f2226868e04 100644
--- a/tests/unit/type/hash.tcl
+++ b/tests/unit/type/hash.tcl
@@ -68,6 +68,11 @@ start_server {tags {"hash"}} {
         r hrandfield myhash 0
     } {}
 
+    test "HRANDFIELD count overflow" {
+        r hmset myhash a 1
+        assert_error {*value is out of range*} {r hrandfield myhash -9223372036854770000 withvalues}
+    } {}
+
     test "HRANDFIELD with <count> against non existing key" {
         r hrandfield nonexisting_key 100
     } {}
diff --git a/tests/unit/type/zset.tcl b/tests/unit/type/zset.tcl
index 18bae4440fb7..8d7d67794dfa 100644
--- a/tests/unit/type/zset.tcl
+++ b/tests/unit/type/zset.tcl
@@ -1735,6 +1735,11 @@ start_server {tags {"zset"}} {
         r zrandmember nonexisting_key 100
     } {}
 
+    test "ZRANDMEMBER count overflow" {
+        r zadd myzset 0 a
+        assert_error {*value is out of range*} {r zrandmember myzset -9223372036854770000 withscores}
+    } {}
+
     # Make sure we can distinguish between an empty array and a null response
     r readraw 1
 
