From 1e8427261fc41d73c90876af48c772b7af704d15 Mon Sep 17 00:00:00 2001
From: Laurent Stacul <laurent.stacul@amadeus.com>
Date: Tue, 23 Feb 2021 17:34:14 +0000
Subject: [PATCH] Fix EVP_Cipher interface change in openssl 3

The change is described there:
https://github.com/openssl/openssl/commit/f7397f0d58ce7ddf4c5366cd1846f16b341fbe43
---
 src/openssl.c | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/src/openssl.c b/src/openssl.c
index 65a6c1736a..c286bc61c1 100644
--- a/src/openssl.c
+++ b/src/openssl.c
@@ -427,10 +427,19 @@ _libssh2_cipher_crypt(_libssh2_cipher_ctx * ctx,
 #else
     ret = EVP_Cipher(ctx, buf, block, blocksize);
 #endif
+#if defined(OPENSSL_VERSION_MAJOR) && OPENSSL_VERSION_MAJOR >= 3
+    if(ret != -1) {
+#else
     if(ret == 1) {
+#endif
         memcpy(block, buf, blocksize);
     }
+
+#if defined(OPENSSL_VERSION_MAJOR) && OPENSSL_VERSION_MAJOR >= 3
+    return ret != -1 ? 0 : 1;
+#else
     return ret == 1 ? 0 : 1;
+#endif
 }
 
 #if LIBSSH2_AES_CTR && !defined(HAVE_EVP_AES_128_CTR)

