From d95737ca690bc6685f0c5195ce10eaf0df6d928a Mon Sep 17 00:00:00 2001
From: Oliver Kurth <okurth@gmail.com>
Date: Wed, 3 May 2023 12:18:07 -0700
Subject: [PATCH 08/14] run fstrim on filesystems just before unmounting

Change-Id: I2f743a0754b8a21ddf4d565854e3847abbbe0a21
---
 photon_installer/installer.py | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/photon_installer/installer.py b/photon_installer/installer.py
index 1701f7c..25f42c1 100644
--- a/photon_installer/installer.py
+++ b/photon_installer/installer.py
@@ -677,7 +677,8 @@ class Installer(object):
         """
         while self.mounts:
             d = self.mounts.pop()
-            retval = self.cmd.run(['umount', '-l', d])
+            self.cmd.run(["fstrim", d])
+            retval = self.cmd.run(["umount", "-l", d])
             if retval != 0:
                 self.logger.error(f"Failed to unmount {d}")
 
-- 
2.23.1

