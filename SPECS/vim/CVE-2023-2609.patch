From d1ae8366aff286d41e7f5bc513cc0a1af5130aad Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Tue, 9 May 2023 17:09:30 +0100
Subject: [PATCH] patch 9.0.1531: crash when register contents ends up being
 invalid

Problem:    Crash when register contents ends up being invalid.
Solution:   Check "y_array" is not NULL.

[ssrish: resolved a hunk failure]
Signed-off-by: Srish Srinivasan <ssrish@vmware.com>
---
 src/register.c                 |  2 +-
 src/testdir/test_registers.vim | 17 +++++++++++++++++
 src/version.c                  |  2 ++
 3 files changed, 20 insertions(+), 1 deletion(-)

diff --git a/src/register.c b/src/register.c
index 782bd4d..beeeed9 100644
--- a/src/register.c
+++ b/src/register.c
@@ -300,7 +300,7 @@ get_register(
 	if (copy)
 	{
 	    // If we run out of memory some or all of the lines are empty.
-	    if (reg->y_size == 0)
+            if (reg->y_size == 0 || y_current->y_array == NULL)
 		reg->y_array = NULL;
 	    else
 		reg->y_array = ALLOC_MULT(char_u *, reg->y_size);
diff --git a/src/testdir/test_registers.vim b/src/testdir/test_registers.vim
index 3522649..5622dcf 100644
--- a/src/testdir/test_registers.vim
+++ b/src/testdir/test_registers.vim
@@ -798,6 +798,23 @@ func Test_end_reg_executing()
   bwipe!
 endfunc

+" This was causing a crash because y_append was ending up being NULL
+func Test_zero_y_append()
+  " Run in a separate Vim instance because changing 'encoding' may cause
+  " trouble for later tests.
+  let lines =<< trim END
+      d
+      silent ?n
+      next <sfile>
+      so
+      sil! norm 0VÂ€PSP
+      set enc=latin1
+
+  END
+  call writefile(lines, 'XTest_zero_y_append', 'D')
+  call RunVim([], [], '-u NONE -i NONE -e -s -S XTest_zero_y_append -c qa\!')
+endfunc
+
 " Make sure that y_append is correctly reset
 " and the previous register is working as expected
 func Test_register_y_append_reset()
diff --git a/src/version.c b/src/version.c
index f102a2c..55197e0 100644
--- a/src/version.c
+++ b/src/version.c
@@ -735,6 +735,8 @@ static char *(features[]) =

 static int included_patches[] =
 {   /* Add new patch number below this line */
+/**/
+    1531,
 /**/
     1532,
 /**/
--
2.35.6
